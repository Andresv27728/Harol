import axios from 'axios';
import fetch from 'node-fetch';

const pendingQueries = new Map();

const handler = async (msg, { conn, args, usedPrefix, command }) => {
  const chatId = msg.key.remoteJid;
  const userId = msg.sender;

  // Detectar si es respuesta a bot√≥n
  const isButtonResponse = !!msg.message?.buttonsResponseMessage;
  const selectedButtonId = isButtonResponse ? msg.message.buttonsResponseMessage.selectedButtonId : null;

  if (isButtonResponse) {
    const originalQuestion = pendingQueries.get(userId);
    if (!originalQuestion) {
      return conn.sendMessage(chatId, { text: 'No tengo ninguna pregunta pendiente, escribe tu pregunta primero.' }, { quoted: msg });
    }
    pendingQueries.delete(userId);

    let prefix = '';
    if (selectedButtonId === 'xex') prefix = 'Comportate como xex: ';
    else if (selectedButtonId === 'china') prefix = 'Comportate como china: ';
    else prefix = '';

    const finalQuery = prefix + originalQuestion;
    await processQuery(finalQuery, msg, conn);
    return;
  }

  // Si no es bot√≥n, es la pregunta inicial
  const text = args.join(' ');
  if (!text) {
    return conn.sendMessage(chatId, {
      text: `‚ú≥Ô∏è Ingresa tu pregunta\nEjemplo: *${usedPrefix + command}* ¬øqui√©n invent√≥ WhatsApp?`
    }, { quoted: msg });
  }

  // Guardamos la pregunta para despu√©s cuando elijan bot√≥n
  pendingQueries.set(userId, text);

  const textoBotones = `¬øCon qui√©n quieres hablar? Escoge una opci√≥n:`;
  const botones = [
    { buttonId: 'xex', buttonText: { displayText: 'Xex' }, type: 1 },
    { buttonId: 'china', buttonText: { displayText: 'China' }, type: 1 },
  ];

  const mensaje = {
    text: textoBotones,
    footer: 'By MaycolAI ü§ñ‚ù§',
    buttons: botones,
    headerType: 1
  };

  await conn.sendMessage(chatId, mensaje, { quoted: msg });
};

async function processQuery(query, msg, conn) {
  const chatId = msg.key.remoteJid;
  try {
    await conn.sendMessage(chatId, { react: { text: 'üï≥Ô∏è', key: msg.key } });

    const name = msg.pushName || 'Usuario';
    const prompt = await getPrompt();
    let result = '';

    try {
      result = await luminaiQuery(query, name, prompt);
      result = cleanResponse(result);
    } catch (e) {
      console.error('Error Luminai:', e);
      try {
        result = await perplexityQuery(query, prompt);
      } catch (e) {
        console.error('Error Perplexity:', e);
        throw new Error('No se obtuvo respuesta de los servicios');
      }
    }

    await conn.sendMessage(chatId, { text: result }, { quoted: msg });
    await conn.sendMessage(chatId, { react: { text: 'üí©', key: msg.key } });

  } catch (error) {
    console.error(error);
    await conn.sendMessage(chatId, {
      text: `‚ùå Error: ${error.message}`
    }, { quoted: msg });

    await conn.sendMessage(chatId, { react: { text: '‚ùå', key: msg.key } });
  }
}

async function getPrompt() {
  try {
    const res = await fetch('https://raw.githubusercontent.com/elrebelde21/LoliBot-MD/main/src/text-chatgpt.txt');
    return await res.text();
  } catch {
    return 'Eres un asistente inteligente';
  }
}

function cleanResponse(text) {
  if (!text) return '';
  return text
    .replace(/Maaf, terjadi kesalahan saat memproses permintaan Anda/g, '')
    .replace(/Generated by BLACKBOX\.AI.*?https:\/\/www\.blackbox\.ai/g, '')
    .replace(/and for API requests replace https:\/\/www\.blackbox\.ai with https:\/\/api\.blackbox\.ai/g, '')
    .trim();
}

async function luminaiQuery(q, user, prompt) {
  const { data } = await axios.post('https://luminai.my.id', {
    content: q,
    user: user,
    prompt: prompt,
    webSearchMode: true
  });
  return data.result;
}

async function perplexityQuery(q, prompt) {
  const { data } = await axios.get('https://api.perplexity.ai/chat', {
    params: {
      query: q,
      context: prompt
    }
  });
  return data.response;
}

handler.help = ['xex <pregunta>'];
handler.command = ['xex', 'ai', 'ask'];
handler.tags = ['ai'];
handler.register = true;

export default handler;
